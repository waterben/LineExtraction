# Precision Optimizer

Sub-pixel line localization via numerical optimization.

[← Back to Line Analyzer](../../README.md)

## Overview

Optimizes sub-pixel line localization by maximizing the mean gradient response along a line segment's profile. Uses numerical optimization to refine the position and angle of detected lines for higher geometric accuracy.

## How It Works

The optimizer searches over two degrees of freedom — orthogonal offset `d` and rotation angle `r` — to find the line position that maximizes the mean gradient magnitude sampled perpendicular to the line.

```
  Original detected line:

       ●══════════════●   (coarse position from detector)

  Optimization search space:

       ←── d (profile offset, ±pixels) ──→

              ╱  r (rotation, ±degrees)
       ●═════╱══════════●
             ╱
            ╱
       ●══════════════════●   ← optimized position (max gradient)
```

The objective function is the average gradient magnitude along the line's support region. The optimizer moves the line orthogonally and rotates it slightly to find the peak response.

## Controls

| Control | Description | Default |
|---------|-------------|---------|
| **Search Strategy** | Optimization algorithm: BFGS, L-BFGS, or Conjugate Gradient | BFGS |
| **Stopping Criterion** | Convergence test: Delta (function value change) or Gradient Norm | Delta |
| **Stop Value** | Threshold for the stopping criterion | 1e-7 |
| **Max Iterations** | Maximum number of optimizer iterations (capped for responsiveness) | 1000 |
| **Profile Range** | Orthogonal search half-range (±pixels) | 1.0 |
| **Rotation Range** | Angular search half-range (±degrees). Disabled when auto-rotation is active. | 1.0 |
| **Auto Rotation** | Derive rotation range from the detector's gradient kernel size: ±atan(1 / ⌊k/2⌋)° | Off |
| **Interpolation** | Sub-pixel gradient sampling method (nearest, bilinear, bicubic) | Bilinear |
| **Fast Interpolation** | Trade accuracy for speed in sub-pixel sampling | On |
| **Data Source** | Gradient magnitude source to evaluate | — |
| **Line Distance** | Mean calculation parameter (support pixels) | 1 |

## Operations

- **Optimize Selected:** Refine the currently selected line segment
- **Optimize All:** Batch-optimize all detected line segments
- **Undo:** Revert the last optimization step

## Workflows

### Optimize a Single Line

1. **Detect lines** in the ControlWindow.
2. **Select a line** by clicking it in the main plot or table. The Precision Optimizer receives the selection via `lineSelChanged`.
3. **Choose a data source** from the dropdown — typically a gradient magnitude image (`mag`, `qmag`, or `nmag`) generated by the detector.
4. **Set the search parameters:**
   - *Profile Range* — orthogonal search half-range (±pixels). Increase if the line is far from the true edge.
   - *Rotation Range* — angular search half-range (±degrees). Or enable **Auto Rotation** to derive it from the gradient kernel size.
   - *Interpolation* — sub-pixel sampling method (bilinear is usually sufficient).
5. **Click "Optimize Selected"** (`pb_line`). The optimizer runs BFGS (or L-BFGS / CG) to find the position that maximizes the mean gradient response. The line shifts in the main plot when done.
6. **Inspect the result** in the [Profile Analyzer](../profileanalyzer/README.md) — the gradient peak should now be sharper and better centered.

### Batch-Optimize All Lines

1. **Detect lines** and **set parameters** as above.
2. **Click "Optimize All"** (`pb_all`). Every detected line is refined sequentially.
3. **Review** the results in the main plot. Lines that were already well-positioned will barely move; misaligned lines shift noticeably.
4. **Evaluate** the improvement by running the [Accuracy Measure](../accuracy/README.md) before and after optimization.

### Use with Analysis Mode (Line Analyser 2D)

1. **Detect lines, load GT, and compute correct lines** in the [Line Analyser 2D](../lineanalyser2d/README.md) panel.
2. **Start Analysis mode** in Line Analyser 2D and **Freeze All** to save the pre-optimization state.
3. **Open the Precision Optimizer and run Optimize All.**
4. Line Analyser 2D automatically receives the updated lines and recomputes correct lines, populating the before/after comparison tables.

## Use Case

Improve endpoint precision of detected lines. Particularly useful when the detector provides good coarse localization but sub-pixel accuracy matters (e.g., for 3D reconstruction or precise measurement applications).

## Auto Rotation

When **Auto Rotation from kernel size** is checked, the rotation search range is
automatically derived from the active detector's `grad_kernel_size` parameter:

$$\text{range} = \pm\arctan\!\left(\frac{1}{\lfloor k/2 \rfloor}\right)°$$

| Kernel size | Half-width | Auto range |
|:-----------:|:----------:|:----------:|
| 3 | 1 | ±45.0° |
| 5 | 2 | ±26.6° |
| 7 | 3 | ±18.4° |
| 9 | 4 | ±14.0° |
| 11 | 5 | ±11.3° |

The value is refreshed when the detector changes and also right before each
optimization run, so manual parameter edits in ControlWindow's table are always
picked up.

## Algorithm

The [`PrecisionOptimize`](../../../../libs/algorithm/README.md#precisionoptimize) optimizer uses dlib's numerical optimization routines:

1. Define the objective: mean gradient magnitude along the line's perpendicular profile.
2. Choose a search strategy (BFGS for most cases, CG for large-scale problems).
3. Iteratively adjust the line's orthogonal offset and rotation to maximize the objective.
4. Stop when the convergence criterion is met (function value delta or gradient norm).

See the [Algorithm Library documentation](../../../../libs/algorithm/README.md#precisionoptimize) for the full API and C++/Python usage examples.

## Files

| File | Purpose |
|------|---------|
| [precisionoptimizer.h](precisionoptimizer.h) | Panel class declaration (inherits `LATool`) |
| [precisionoptimizer.cpp](precisionoptimizer.cpp) | Optimization loop, objective function evaluation |
| [precisionoptimizer.ui](precisionoptimizer.ui) | Qt Designer layout |

## Dependencies

- **ControlWindow** — line data, image sources, line modification signals
- **libs/algorithm** — [`PrecisionOptimize`](../../../../libs/algorithm/README.md#precisionoptimize) numerical optimization framework
- **QCustomPlot** — convergence plot
