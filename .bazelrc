# LineExtraction Bazel Configuration

# Enable Bzlmod (MODULE.bazel)
common --enable_bzlmod

# Leads to inconsistent behavior with some dependencies
common --lockfile_mode=off

# Picks up host OS specific configs
# Docs: https://bazel.build/reference/command-line-reference#flag--enable_platform_specific_config
common --enable_platform_specific_config

# Register local Bazel registry for custom modules
common --registry=file://%workspace%/tools/bazel/registry
common --registry=https://bcr.bazel.build

# So we can support private dependencies
build --experimental_cc_implementation_deps

# Use a static value for `PATH` and does not inherit `LD_LIBRARY_PATH`. Doesn't let environment
# variables like `PATH` sneak into the build, which can cause massive cache misses when they change.
# Use `--action_env=ENV_VARIABLE` if you want to inherit specific environment variables from the
# client, but note that doing so can prevent cross-user caching if a shared cache is used.
# Docs: https://bazel.build/reference/command-line-reference#flag--incompatible_strict_action_env
build --incompatible_strict_action_env

build --strip=never

# Use auto-detected system toolchains by default
# Custom toolchains can be enabled via --config=custom_toolchain
# common --repo_env BAZEL_DO_NOT_DETECT_CPP_TOOLCHAIN=1

build --force_pic

# Use colors to highlight output on the screen.
# Docs: https://bazel.build/docs/user-manual#color
build --color=yes

# Speed up all builds by not checking if external repository files have been modified.
# Docs: https://github.com/bazelbuild/bazel/blob/1af61b21df99edc2fc66939cdf14449c2661f873/src/main/java/com/google/devtools/build/lib/bazel/repository/RepositoryOptions.java#L244
# common --noexperimental_check_external_repository_files

# Directories used by sandboxed non-worker execution may be reused to avoid unnecessary setup costs.
# Save time on Sandbox creation and deletion when many of the same kind of action run during the
# build.
# Docs: https://bazel.build/reference/command-line-reference#flag--reuse_sandbox_directories
build --reuse_sandbox_directories

# Do not build runfiles symlink forests for external repositories under
# `.runfiles/wsname/external/repo` (in addition to `.runfiles/repo`). This reduces runfiles &
# sandbox creation times & prevents accidentally depending on this feature which may flip to off by
# default in the future. Note, some rules may fail under this flag, please file issues with the rule
# author.
# Docs: https://bazel.build/reference/command-line-reference#flag--legacy_external_runfiles
build --nolegacy_external_runfiles

# Bazel 8.0.0 will switch this to true. This leads to build errors on some transitive dependencies.
# common --incompatible_disallow_empty_glob=false

# Platform configuration (use defaults, auto-detected)
# Custom platforms can be added later if needed
# build --host_platform=//tools/bazel/platforms:linux_x86_64_gcc
# build --platforms=//tools/bazel/platforms:linux_x86_64_gcc

# disable warnings for external dependencies
build --host_per_file_copt external/.*@-w
build --per_file_copt external/.*@-w

# Print errors during tests to stdout
test --test_output=errors

# Set this flag to enable re-tries of failed tests on CI.
# When any test target fails, try one or more times. This applies regardless of whether the "flaky"
# tag appears on the target definition.
# This is a tradeoff: legitimately failing tests will take longer to report,
# but we can paper over flaky tests that pass most of the time.
# The alternative is to mark every flaky test with the `flaky = True` attribute, but this requires
# the buildcop to make frequent code edits.
# Not recommended for local builds so that the flakiness is observed during development and thus
# is more likely to get fixed.
# Note that when passing after the first attempt, Bazel will give a special "FLAKY" status.
# Docs: https://bazel.build/docs/user-manual#flaky-test-attempts
test:ci --flaky_test_attempts=2

# Announce all announces command options read from the bazelrc file(s) when starting up at the
# beginning of each Bazel invocation. This is very useful on CI to be able to inspect what Bazel rc
# settings are being applied on each run.
# Docs: https://bazel.build/docs/user-manual#announce-rc
build:ci --announce_rc

# Suppress action stdout+stderr if action succeeded
build:ci --auto_output_filter=all

# Temporary messaging to the user. Don't add more of those.
build:ci --unconditional_warning="ðŸ¤« Log output for successful actions is disabled by default. Re-enable with '--auto_output_filter=none'"

# Add a timestamp to each message generated by Bazel specifying the time at which the message was
# displayed.
# Docs: https://bazel.build/docs/user-manual#show-timestamps
build:ci --show_timestamps

# The terminal width in columns. Configure this to override the default value based on what your CI system renders.
# Docs: https://github.com/bazelbuild/bazel/blob/1af61b21df99edc2fc66939cdf14449c2661f873/src/main/java/com/google/devtools/build/lib/runtime/UiOptions.java#L151
build:ci --terminal_columns=143

# Allow a user to customize their bazel config
try-import %workspace%/.user.bazelrc

# C++ Standard
build --cxxopt=-std=c++17
build --host_cxxopt=-std=c++17

# Clang configuration (optional, use --config=clang)
build:clang --repo_env=CC=clang
build:clang --repo_env=CXX=clang++
build:clang --define=COMPILER=clang
# Suppress warnings that occur in OpenCV headers when included via templates
# Using per_file_copt to apply AFTER all other copts for non-external files
build:clang --per_file_copt=^(?!external/).*@-Wno-cast-align,-Wno-c11-extensions
# build:clang --cxxopt=-stdlib=libc++
# build:clang --linkopt=-stdlib=libc++

# GCC configuration (default)
build:gcc --repo_env=CC=gcc
build:gcc --repo_env=CXX=g++


# Compiler selection
# Use these with --config=gcc or --config=clang
# build:gcc --repo_env=CC=gcc
# build:gcc --repo_env=CXX=g++
# build:gcc --cxxopt=-fPIC

# build:clang --repo_env=CC=clang
# build:clang --repo_env=CXX=clang++
# build:clang --cxxopt=-fPIC

# Default to GCC if not specified
# build --config=gcc

# Debug configuration
build:debug --compilation_mode=dbg
build:debug --cxxopt=-g
build:debug --cxxopt=-O0
build:debug --strip=never
build:debug --copt=-DDEBUG

# Release configuration
build:release --compilation_mode=opt
build:release --cxxopt=-O3
build:release --cxxopt=-ffast-math
build:release --cxxopt=-DNDEBUG
build:release --strip=always

# Test configuration
# test --test_output=errors
# test --test_summary=detailed
# test --test_verbose_timeout_warnings

# Build output
# build --verbose_failures
# build --announce_rc

# Colors and UI
# common --color=yes
# common --curses=yes

# Performance
build --jobs=auto
build --local_resources=cpu=HOST_CPUS-1

# Disk cache
build --disk_cache=~/.cache/bazel/line_extraction

# Remote cache (optional, uncomment if you have one)
# build --remote_cache=grpc://your-cache-server:port

# Use platforms for cross-compilation
# Note: Using built-in toolchains, not custom ones
# build --incompatible_enable_cc_toolchain_resolution

# Additional debugging feature for development
build:debugging_feature --config=debug
build:debugging_feature --cxxopt=-ggdb3
build:debugging_feature --cxxopt=-fno-omit-frame-pointer

# Address Sanitizer
build:asan --strip=never
build:asan --copt=-fsanitize=address
build:asan --copt=-DADDRESS_SANITIZER
build:asan --copt=-O1
build:asan --copt=-g
build:asan --copt=-fno-omit-frame-pointer
build:asan --linkopt=-fsanitize=address

# Thread Sanitizer
build:tsan --strip=never
build:tsan --copt=-fsanitize=thread
build:tsan --copt=-DTHREAD_SANITIZER
build:tsan --copt=-O1
build:tsan --copt=-g
build:tsan --copt=-fno-omit-frame-pointer
build:tsan --linkopt=-fsanitize=thread

# Config to bypass disk cache for fresh builds
build:nocache --disk_cache=""

# =============================================================================
# GTK3 Support for OpenCV highgui (Linux only)
# =============================================================================
# Enable GTK3 support for OpenCV window functions (imshow, waitKey, etc.)
# Requires: sudo apt install libgtk-3-dev
build:gtk --@opencv//:with_gtk3=True
build:gtk --@opencv//:gtk3=@ubuntu_gtk_deps//:gtk3

# Try to import user-specific .bazelrc if it exists
try-import %workspace%/.bazelrc.user
