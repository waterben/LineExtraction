# LineExtraction Project Environment
# This file is sourced automatically:
#   - VS Code: via terminal.integrated.env.linux BASH_ENV setting
#   - Docker: via .bashrc entry
# It provides consistent environment setup across all development environments

# ============================================================================
# Bash Completion
# ============================================================================

# Enable programmable completion features
if ! shopt -oq posix; then
    if [[ -f /usr/share/bash-completion/bash_completion ]]; then
        source /usr/share/bash-completion/bash_completion
    elif [[ -f /etc/bash_completion ]]; then
        source /etc/bash_completion
    fi
fi

# ============================================================================
# Shell Prompt Configuration (Git-aware colored prompt)
# ============================================================================

# Source git-prompt if available (provides __git_ps1)
if [[ -f /usr/local/bin/git-prompt.sh ]]; then
    source /usr/local/bin/git-prompt.sh
elif [[ -f /usr/share/git-core/contrib/completion/git-prompt.sh ]]; then
    source /usr/share/git-core/contrib/completion/git-prompt.sh
elif [[ -f /etc/bash_completion.d/git-prompt ]]; then
    source /etc/bash_completion.d/git-prompt
fi

# Only configure prompt if __git_ps1 is available and PS1 not already customized
if type __git_ps1 &>/dev/null && [[ "${PROJECT_ENV_LOADED:-0}" != "1" ]]; then
    # Color codes
    export COLOR_RED="\[\033[1;31m\]"
    export COLOR_GREEN="\[\033[1;32m\]"
    export COLOR_YELLOW="\[\033[1;33m\]"
    export COLOR_BLUE="\[\033[1;34m\]"
    export COLOR_CYAN="\[\033[1;36m\]"
    export COLOR_END="\[\033[0m\]"

    # Git prompt options
    export GIT_PS1_SHOWDIRTYSTATE=1        # * for unstaged, + for staged
    export GIT_PS1_SHOWSTASHSTATE=1        # $ if something is stashed
    export GIT_PS1_SHOWUNTRACKEDFILES=1    # % if untracked files
    export GIT_PS1_SHOWUPSTREAM="auto"     # <, >, <>, = for behind, ahead, diverged, equal
    export GIT_PS1_DESCRIBE_STYLE="branch"
    export GIT_PS1_SHOWCOLORHINTS=1

    # Colored prompt: user@host:path (git-branch)
    export PS1="${COLOR_GREEN}\u@\h${COLOR_END}:${COLOR_CYAN}\w${COLOR_YELLOW}\$(__git_ps1 ' (%s)')${COLOR_END}\n> "
fi

# ============================================================================
# Display Configuration (X11/Wayland for GUI applications)
# ============================================================================

# WSL2 with WSLg (Windows 11+): Set DISPLAY for X11 apps
if [[ -z "${DISPLAY}" ]] && grep -qi microsoft /proc/version 2>/dev/null; then
    export DISPLAY=:0
fi

# ============================================================================
# Python Virtual Environment
# ============================================================================

# Activate Python virtual environment (only if not already active)
# Note: VS Code Python extension may also activate, so we check VIRTUAL_ENV
if [[ -z "${VIRTUAL_ENV}" ]] && [[ "${VENV_ACTIVATED:-0}" != "1" ]]; then
    # Try project-local .venv first (WSL/local setup)
    if [[ -f "${LE_PROJECT_DIR:-.}/.venv/bin/activate" ]]; then
        source "${LE_PROJECT_DIR:-.}/.venv/bin/activate" >/dev/null 2>&1
        export VENV_ACTIVATED=1
    elif [[ -f "${PWD}/.venv/bin/activate" ]]; then
        source "${PWD}/.venv/bin/activate" >/dev/null 2>&1
        export VENV_ACTIVATED=1
    # Fallback to Docker path
    elif [[ -f "/opt/venv/deps/python/bin/activate" ]]; then
        source "/opt/venv/deps/python/bin/activate" >/dev/null 2>&1
        export VENV_ACTIVATED=1
    fi
fi

# ============================================================================
# Project-specific Settings
# ============================================================================

# Persistent bash history (useful in Docker containers)
if [[ -d "${HOME}/.cmd_history" ]]; then
    export PROMPT_COMMAND="history -a"
    export HISTFILE="${HOME}/.cmd_history/.bash_history"
fi

# ============================================================================
# Bash History Configuration
# ============================================================================
export HISTSIZE=10000
export HISTFILESIZE=20000
export HISTCONTROL=ignoredups:erasedups
export HISTTIMEFORMAT="%F %T "
shopt -s histappend 2>/dev/null

# ============================================================================
# Bash Options
# ============================================================================
shopt -s checkwinsize 2>/dev/null  # Update LINES and COLUMNS after each command
shopt -s cdspell 2>/dev/null       # Autocorrect typos in path names when using cd
shopt -s dirspell 2>/dev/null      # Correct spelling errors during tab-completion
shopt -s nocaseglob 2>/dev/null    # Case-insensitive globbing
shopt -s globstar 2>/dev/null      # Enable ** recursive glob

# ============================================================================
# Aliases
# ============================================================================

# Directory navigation
alias ll='ls -lh'
alias la='ls -lAh'
alias l='ls -CF'
alias ..='cd ..'
alias ...='cd ../..'

# Colored output
alias grep='grep --color=auto'
alias fgrep='fgrep --color=auto'
alias egrep='egrep --color=auto'

# Git aliases
alias gs='git status'
alias gd='git diff'
alias gl='git log --oneline --graph --decorate'
alias gp='git pull'
alias gf='git fetch'

# Development aliases
alias bz='bazel'
alias bzb='bazel build'
alias bzt='bazel test'
alias bzr='bazel run'

# ============================================================================
# Environment Variables
# ============================================================================
export EDITOR="code --wait"

# ============================================================================
# Bazel Completion
# ============================================================================

# Use bazelisk built-in completion (v1.27.0+), fallback to manual script
if command -v bazelisk &>/dev/null && bazelisk completion bash &>/dev/null; then
    eval "$(bazelisk completion bash)"
elif [[ -f "${HOME}/.bazel/bin/bazel-complete.bash" ]]; then
    source "${HOME}/.bazel/bin/bazel-complete.bash"
elif [[ -f "/etc/bash_completion.d/bazel" ]]; then
    source "/etc/bash_completion.d/bazel"
fi

# Mark as loaded to prevent double-loading
export PROJECT_ENV_LOADED=1
