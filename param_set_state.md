# Feature Branch `feature/param-optimizer` — Status Overview

> Branch: `feature/param-optimizer` (based on `main`)
> Last updated: 2026-02-28
> Diff vs main: **78 files changed**, +17,200 / -881 lines

---

## Summary

This PR introduces a new **`libs/algorithm/`** library with 10 components for line segment post-processing, accuracy evaluation, image-adaptive parameter profiles, automated parameter optimization, and JSON preset management. Additionally, it includes a 6th pybind11 module (`le_algorithm`), evaluation tools, dataset setup scripts, an LSD crash fix, a full tutorial notebook, and comprehensive improvements to the **Line Analyzer GUI** (new tool panels, tooltips, help buttons, test image selector, exception handling).

---

## What Was Done

### 1. New Library: `libs/algorithm/`

| Component | Header | Description |
|-----------|--------|-------------|
| **LineMerge** | `line_merge.hpp` | Merges near-collinear segment pairs (4 proximity criteria, STANDARD/AVG modes) |
| **LineConnect** | `line_connect.hpp` | Connects nearby endpoints via gradient-guided path analysis |
| **AccuracyMeasure** | `accuracy_measure.hpp` | Precision/Recall/F1, greedy matching, structural AP |
| **GroundTruthLoader** | `ground_truth.hpp` | Load/save ground truth annotations (CSV format) |
| **ParamOptimizer** | `param_search.hpp` | Orchestrates parameter search (grid/random) over image databases |
| **SearchStrategy** | `search_strategy.hpp` | `GridSearchStrategy` (exhaustive) + `RandomSearchStrategy` (sampling) |
| **PrecisionOptimize** | `precision_optimize.hpp` | Sub-pixel line refinement via dlib (BFGS/L-BFGS/CG) |
| **ImageAnalyzer** | `image_analyzer.hpp/cpp` | Analyzes image properties (contrast, noise, edge density, dynamic range) → `ProfileHints` |
| **DetectorProfile** | `detector_profile.hpp/cpp` | Maps 4 intuitive knobs (detail, gap_tolerance, min_length, precision; 0-100%) to concrete parameters for all 9 LSD detectors. Adaptive scaling via `contrast_factor`/`noise_factor`. Factory: `from_image()`, `from_hints()` |
| **PresetStore** | `preset_store.hpp/cpp` | Loads optimized detector parameter presets from JSON (generated by `optimize_presets.py`). Provides lookup by detector + preset name (fast/balanced/accurate), scores, and apply-to-detector convenience. Uses nlohmann/json |

### 2. Python Bindings (`le_algorithm`)

- 6th pybind11 module with full API coverage (all 10 components, 3 enums, all result structs)
- NumPy zero-copy via cvnp
- `ParamConfig` exposed as `list[dict]` for Pythonic usage
- Location: `libs/algorithm/python/`

### 3. Evaluation Tools

| Tool | Location | Description |
|------|----------|-------------|
| **optimize_presets.py** | `evaluation/python/tools/` | Generates 3 presets (Fast/Balanced/Accurate) for all 9 detectors via random search |
| **detector_statistics.py** | `evaluation/python/tools/` | Benchmarks detectors with default/profile/adaptive strategies, outputs P/R/F1 + timing |

### 4. Dataset Support

| Script | Location | Description |
|--------|----------|-------------|
| **setup_york_urban.sh** | `tools/scripts/` | Downloads York Urban DB (102 images, 640x480) + GT conversion |
| **setup_wireframe.sh** | `tools/scripts/` | Downloads Wireframe dataset (5462 images, HuggingFace mirror) + GT conversion |
| **convert_ground_truth.py** | `tools/scripts/` | Converts .mat/.pkl/.json annotations → GroundTruthLoader CSV format |

### 5. LSD Crash Fix

- **File:** `libs/lsd/include/lsd/lsd_cp.hpp`
- **Bug:** Heap-buffer-overflow when `max_gap_ > 0` (activated by profile/adaptive parameters)
- **Fix:** Bounds check in `move_idx`, tolerance setter hardening, defensive reserve
- **Regression test:** `test_lsd_cp_crash.cpp` (8 test cases at multiple resolutions)

### 6. Line Analyzer GUI Improvements (30 files changed, +3,734 / -871 lines)

Major enhancements to the `apps/line_analyzer/` Qt application:

#### New Tool Panels (integrated into the analyzer)

| Panel | Files | Description |
|-------|-------|-------------|
| **AccuracyPanel** | `accuracypanel.{cpp,h,ui}` | Compare detected lines against ground truth CSV (P/R/F1/sAP) |
| **DetectorProfilePanel** | `detectorprofilepanel.{cpp,h,ui}` | Tune detector parameters via 4 percentage knobs + adaptive image factors |
| **ImageAnalyzerPanel** | `imageanalyzerpanel.{cpp,h,ui}` | Analyze image properties (contrast, noise, edge density, range) + suggest profile |

#### Comprehensive Tooltips & Help Buttons

- **All 11 dialogs** now have descriptive mouse-over tooltips on every interactive field
- **"?" help button** in each dialog opens a rich HTML help window describing the tool and all parameters
- Shared utility: `help_button.hpp` (`addHelpButton()` — consistent 24x24 button at top-right)

#### Test Image Selector

- Category + image combo box row in the control window
- Scans `resources/datasets/` for available images across all datasets (General, Noise, BSDS500, York Urban, Wireframe, MDB)
- Works with both `bazel run` (uses `BUILD_WORKSPACE_DIRECTORY` env var) and standalone execution

#### Exception Handling

- `SafeApplication` class in `main.cpp` catches uncaught exceptions globally
- `try/catch` blocks in all high-risk Qt slots across 9 files
- Graceful error dialogs instead of crashes

#### Other GUI Changes

- `connectionoptimizer`: Fixed `cv::Mat` type mismatch crash in `sample_path()` (switch on `magnitude.depth()`)
- `imageanalyzerpanel`: Emits `sourcesChanged` from `loadImage()` + grayscale conversion fix
- `continuityoptimizer.ui`: Fixed pre-existing bug (maxHeight=110 < minHeight=156)
- `README.md`: Comprehensive rewrite with all tool descriptions

### 7. Other Changes

- `docs/NextSteps.md` — Feature roadmap updated
- `evaluation/python/results.md` — Pre-computed benchmark results on York Urban
- `python/lsfm/data.py` — New accessors: `york_urban()`, `wireframe()`, `ground_truth_csv()`
- `python/lsfm/__init__.py` — Auto-imports `le_algorithm`
- `libs/utility/include/utility/test_images.hpp` — C++ path helpers for new datasets
- `tools/bazel/requirements.in` — Added scipy dependency

---

## Key Benchmark Results

### York Urban (102 images)

| Detector | Default F1 | Adaptive F1 | Improvement |
|----------|-----------|-------------|-------------|
| LsdCP | 0.060 | **0.160** | +167% |
| LsdEDLZ | 0.091 | **0.144** | +58% |
| LsdEL | 0.074 | **0.138** | +86% |
| LsdCC | 0.079 | **0.126** | +59% |
| LsdFBW | 0.076 | **0.123** | +62% |

### Wireframe (50 images)

| Detector | Default F1 | Best F1     | Improvement |
|----------|-----------|-------------|-------------|
| LsdCC    | 0.072     | **0.196** (adaptive)  | +172% |
| LsdCP    | 0.073     | **0.194** (adaptive)  | +166% |
| LsdEDLZ  | 0.117     | **0.186** (adaptive)  | +59%  |
| LsdEL    | 0.034     | **0.128** (adaptive)  | +276% |
| LsdFGioi | 0.101     | **0.124** (profile)   | +23%  |

**Takeaway:** Adaptive parameters (via `DetectorProfile.from_image()`) improve every detector on both datasets. Default parameters dramatically over-detect. All detectors score higher on Wireframe than York Urban.

---

## Test Coverage

| Area | File | Tests |
|------|------|-------|
| C++ algorithm | `libs/algorithm/tests/test_algorithm.cpp` | ~30 tests (LineMerge, LineConnect, AccuracyMeasure, Grid/Random Search, ParamOptimizer, GroundTruth) |
| C++ detector profile | `libs/algorithm/tests/test_detector_profile.cpp` | ~31 tests (ImageAnalyzer, ProfileHints, DetectorProfile, Integration) |
| C++ preset store | `libs/algorithm/tests/test_preset_store.cpp` | 22 tests (construction, lookup, scores, has, enumeration, edge cases) |
| C++ LSD regression | `libs/lsd/tests/test_lsd_cp_crash.cpp` | 8 crash regression tests |
| Python | `libs/algorithm/python/tests/test_le_algorithm.py` | ~67 tests (all components + enums + PresetStore) |
| **Total** | | **77 tests pass** (all green) |

---

## Where to Find Things

### Documentation

| What | Location |
|------|----------|
| Algorithm library README | `libs/algorithm/README.md` |
| Python bindings README | `libs/algorithm/python/README.md` |
| Evaluation README | `evaluation/python/README.md` |
| Benchmark results | `evaluation/python/results.md` |
| Line Analyzer README | `apps/line_analyzer/README.md` |
| Feature roadmap | `docs/NextSteps.md` |

### Examples & Tutorials

| What | Location |
|------|----------|
| Tutorial notebook (full) | `examples/notebooks/tutorial_4_algorithm.ipynb` |

Notebook sections: LineMerge, LineConnect, AccuracyMeasure, GroundTruthLoader, ImageAnalyzer, DetectorProfile, ParamOptimizer, end-to-end pipeline, exercises.

### Source Code

| What | Location |
|------|----------|
| C++ headers | `libs/algorithm/include/algorithm/*.hpp` |
| C++ sources | `libs/algorithm/src/*.cpp` |
| C++ tests | `libs/algorithm/tests/test_*.cpp` (3 test files) |
| Python bindings | `libs/algorithm/python/src/*.cpp` |
| Python tests | `libs/algorithm/python/tests/test_le_algorithm.py` |
| Evaluation tools | `evaluation/python/tools/*.py` |
| Dataset scripts | `tools/scripts/setup_york_urban.sh`, `tools/scripts/setup_wireframe.sh` |
| GT conversion | `tools/scripts/convert_ground_truth.py` |
| LSD fix | `libs/lsd/include/lsd/lsd_cp.hpp` |
| LSD crash test | `libs/lsd/tests/test_lsd_cp_crash.cpp` |
| Line Analyzer GUI | `apps/line_analyzer/*.{cpp,h,ui,hpp}` |

### Build Targets (Bazel)

```bash
# Build algorithm library
bazel build //libs/algorithm:lib_algorithm

# Run algorithm tests
bazel test //libs/algorithm:test_algorithm
bazel test //libs/algorithm:test_detector_profile
bazel test //libs/algorithm:test_preset_store

# Run LSD crash regression test
bazel test //libs/lsd:test_lsd_cp_crash

# Build Python module
bazel build //libs/algorithm/python:le_algorithm

# Run Python tests
bazel test //libs/algorithm/python:test_le_algorithm

# Run Line Analyzer GUI
bazel run //apps/line_analyzer:app_line_analyzer

# Run evaluation tools
bazel run //evaluation/python:optimize_presets -- --help
bazel run //evaluation/python:detector_statistics -- --help

# Run all tests
bazel test //...
```

---

## What's Still Open / In Progress

### ~~Open Item 1: Pre-trained Presets — Ship Optimized Parameter Sets~~ ✅ DONE

**Completed.** Generated `resources/presets/lsd_presets.json` with optimized Fast/Balanced/Accurate parameter sets for all 9 LSD detectors using `optimize_presets.py` on the York Urban dataset (102 images, 10 random samples per detector-preset, seed=42). Total optimization time: ~1h 21m.

**What was done:**

1. Fixed segfault in `ParamOptimizer.optimize()` Python binding — progress callback lambda was capturing a local `std::function` by reference after it went out of scope (dangling reference in `algorithm_binding.cpp`). Changed to capture by value.
2. Fixed `import cv2` failure in `optimize_presets.py` — replaced with lazy import pattern + PIL for image loading (Bazel Python env has no opencv-python pip package).
3. Fixed read-only numpy array from PIL — changed `np.asarray()` to `np.array()` for writeable copy.
4. Ran `optimize_presets.py` with 10 samples on York Urban for all 9 detectors × 3 presets.
5. Generated `resources/presets/lsd_presets.json` (349 lines, 9 detectors, 27 preset configs).
6. PresetStore C++ + Python API fully tested (22 C++ + 18 Python tests).

**Remaining (future):**

- Re-run with 300 samples for publication-quality presets
- Add `resources/presets/lsd_presets.json` to Bazel data dependencies
- Optionally integrate PresetStore into the Line Analyzer GUI
- Update documentation and tutorial notebook

### ~~Open Item 2: PrecisionOptimize Integration into Evaluation Pipeline~~ ✅ DONE

**Completed.** Both `detector_statistics.py` and `optimize_presets.py` now accept a `--refine` flag that applies `PrecisionOptimize` (sub-pixel line refinement) after detection. Implementation includes:

- Lazy `cv2` import + `_compute_gradient_magnitude()` Sobel helper
- `PrecisionOptimize` instantiated once per worker, applied between detection and evaluation
- `--refine` flag threaded through multiprocessing in detector_statistics.py and through the optimization closure in optimize_presets.py
- Metadata records include the refine setting

### ~~Open Item 3: Wireframe Dataset Evaluation~~ ✅ DONE

**Completed.** Full evaluation on 50 Wireframe images with all 9 detectors × 3 strategies. Results appended to `evaluation/python/results.md` with:

- Full aggregate results table (27 detector/strategy combinations)
- Best strategy per detector summary
- Cross-dataset comparison (York Urban vs Wireframe)

Key findings: All detectors score higher on Wireframe. LsdCC leads with F1=0.196 (adaptive). LsdEDLZ remains the best speed-accuracy trade-off at F1=0.186, 6.2 ms/image.

---

## Completed

- [x] `libs/algorithm/` C++ library (10 components incl. PresetStore)
- [x] Python bindings (`le_algorithm`, 67 tests)
- [x] Evaluation tools (`optimize_presets.py`, `detector_statistics.py`) with `--refine` support
- [x] Dataset support (York Urban, Wireframe, GT conversion)
- [x] LSD crash fix + regression tests
- [x] York Urban benchmark results
- [x] Wireframe benchmark results (cross-dataset comparison)
- [x] PresetStore C++ + Python (nlohmann/json, 22 C++ tests + 18 Python tests)
- [x] PrecisionOptimize Python binding (3 enums, dict params, 10 tests)
- [x] `--refine` flag in both eval scripts (PrecisionOptimize integration)
- [x] Tutorial notebook (`tutorial_4_algorithm.ipynb`)
- [x] Line Analyzer GUI: New tool panels (AccuracyPanel, DetectorProfilePanel, ImageAnalyzerPanel)
- [x] Line Analyzer GUI: Tooltips on every field in all 11 dialogs
- [x] Line Analyzer GUI: "?" help buttons in all 11 dialogs
- [x] Line Analyzer GUI: Test image selector (category + image combos)
- [x] Line Analyzer GUI: Exception handling (SafeApplication + try/catch in all slots)
- [x] Line Analyzer GUI: Bug fixes (ConnectionOptimizer crash, ImageAnalyzer data, layout fixes)
- [x] Line Analyzer GUI: README rewrite
- [x] All 77 tests pass (76 C++ + Python lib tests + 1 new PresetStore C++ test)
