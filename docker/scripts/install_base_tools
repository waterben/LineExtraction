#!/bin/bash

# Internal script: Install base development tools (buildifier, bazelisk, gh, actionlint, yq, uv, ruff)
# This script is used by both Dockerfile and local setup scripts
# Not intended for direct user execution

set -euo pipefail

# Version variables with defaults (can be overridden by caller)
UV_VERSION="${UV_VERSION:-0.8.4}"
BUILDIFIER_VERSION="${BUILDIFIER_VERSION:-8.2.1}"
BAZELISK_VERSION="${BAZELISK_VERSION:-1.26.0}"
GH_VERSION="${GH_VERSION:-2.76.2}"
ACTIONLINT_VERSION="${ACTIONLINT_VERSION:-1.7.7}"
YQ_VERSION="${YQ_VERSION:-4.47.1}"
RUFF_VERSION="${RUFF_VERSION:-0.12.7}"

# Installation directory (default to /usr/local/bin)
INSTALL_DIR="${INSTALL_DIR:-/usr/local/bin}"

install_base_tools() {
    echo "Installing base development tools..."

    # Download and install buildifier
    curl -Ls "https://github.com/bazelbuild/buildtools/releases/download/v${BUILDIFIER_VERSION}/buildifier-linux-amd64" \
        -o "$INSTALL_DIR/buildifier"

    # Download and install bazelisk
    curl -Ls "https://github.com/bazelbuild/bazelisk/releases/download/v${BAZELISK_VERSION}/bazelisk-linux-amd64" \
        -o "$INSTALL_DIR/bazelisk"

    # Download and install GitHub CLI
    curl -Ls "https://github.com/cli/cli/releases/download/v${GH_VERSION}/gh_${GH_VERSION}_linux_amd64.tar.gz" \
        | tar xfz - --strip-components=1 -C /usr/local

    # Download and install actionlint
    curl -Ls "https://github.com/rhysd/actionlint/releases/download/v${ACTIONLINT_VERSION}/actionlint_${ACTIONLINT_VERSION}_linux_amd64.tar.gz" \
        | tar xfz - -C "$INSTALL_DIR"

    # Download and install yq
    curl -Ls "https://github.com/mikefarah/yq/releases/download/v${YQ_VERSION}/yq_linux_amd64" \
        -o "$INSTALL_DIR/yq"

    # Download and install uv
    curl -Ls "https://github.com/astral-sh/uv/releases/download/${UV_VERSION}/uv-x86_64-unknown-linux-musl.tar.gz" \
        | tar xfz - --strip-components=1 -C "$INSTALL_DIR"

    # Download and install ruff
    curl -Ls "https://github.com/astral-sh/ruff/releases/download/${RUFF_VERSION}/ruff-x86_64-unknown-linux-musl.tar.gz" \
        | tar xfz - --strip-components=1 -C "$INSTALL_DIR"

    # Create bazel symlink
    ln -s "$INSTALL_DIR/bazelisk" "$INSTALL_DIR/bazel"

    # Set permissions
    chmod 755 "$INSTALL_DIR/yq"
    chmod 755 "$INSTALL_DIR/buildifier"
    chmod 755 "$INSTALL_DIR/bazelisk"
    chmod 755 "$INSTALL_DIR/actionlint"
    chmod 755 "$INSTALL_DIR/uv"
    chmod 755 "$INSTALL_DIR/uvx"
    chmod 755 "$INSTALL_DIR/ruff"

    # Verify installations
    yq --version
    buildifier --version
    bazel --version
    actionlint --version
    uv --version
    gh --version
}

# Execute if called directly
install_base_tools
